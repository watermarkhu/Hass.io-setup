[{"id":"c13ac1ee.fc1dd","type":"tab","label":"Phone","disabled":false,"info":""},{"id":"cad8f072.3f332","type":"tab","label":"Alarm","disabled":false,"info":""},{"id":"9148f6af.55f788","type":"tab","label":"ZHA","disabled":false,"info":""},{"id":"e614faca.3700f8","type":"tab","label":"Testing","disabled":false,"info":""},{"id":"d79169ed.74c6f8","type":"subflow","name":"Notify phone","info":"","category":"","in":[{"x":140,"y":160,"wires":[{"id":"bb0e717.87eeb9"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"168dec6b.d1ade4","type":"subflow","name":"GHM entity","info":"","category":"","in":[{"x":220,"y":180,"wires":[{"id":"c2af155d.26a098"}]}],"out":[{"x":620,"y":180,"wires":[{"id":"c2af155d.26a098","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"cd10b942.aa6d58","type":"server","name":"Home Assistant","addon":true},{"id":"37c5ac0.abecf54","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#333333","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"26a1389a.64f188","type":"spotify-auth","name":"","scope":""},{"id":"5a5c4cbf.64e5d4","type":"api-current-state","z":"cad8f072.3f332","name":"Alarm music","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.wakeup_music","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":970,"y":420,"wires":[["83498812.99d548"]]},{"id":"83498812.99d548","type":"switch","z":"cad8f072.3f332","name":"Wakeup music","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Lost in Japan","vt":"str"},{"t":"eq","v":"Spotify","vt":"str"},{"t":"eq","v":"Radio","vt":"str"},{"t":"eq","v":"Podcast","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":1130,"y":420,"wires":[["1422d08d.13746f"],["6eb55594.9c8f6c"],["ee0ea774.893528"],["e5461758.d10938"]]},{"id":"ee0ea774.893528","type":"api-call-service","z":"cad8f072.3f332","name":"Play radio","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.play_radio","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1300,"y":440,"wires":[[]]},{"id":"6eb55594.9c8f6c","type":"api-call-service","z":"cad8f072.3f332","name":"Play playlist","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.play_spotcast_playlist","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1300,"y":400,"wires":[[]]},{"id":"e5461758.d10938","type":"api-call-service","z":"cad8f072.3f332","name":"Play podcast","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.play_spotcast_podcast","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1310,"y":480,"wires":[[]]},{"id":"73b86947.f59d88","type":"looptimer","z":"cad8f072.3f332","duration":"6","units":"Second","maxloops":"10","maxtimeout":"1","maxtimeoutunits":"Minute","name":"","x":970,"y":580,"wires":[["f018816c.f1da9"],[]]},{"id":"9eb18e72.1b66c","type":"trigger-state","z":"cad8f072.3f332","name":"Alarm snoozed","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"input_select.alarm_state","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"id":"nfjse936n9","targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Activated"},{"id":"1hrf6ol6og2","targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Snoozed"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":140,"y":560,"wires":[["ec60ae7a.5fb4c","e9a0626b.71ed3","bd3b178e.7e6208"],[]]},{"id":"3262d2f4.aabdfe","type":"trigger-state","z":"cad8f072.3f332","name":"Alarm snoozed inv","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"input_select.alarm_state","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Snoozed","propertyValue":"new_state.state"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"Activated","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":140,"y":820,"wires":[["4dc9ab7f.ed5e44"],[]]},{"id":"4dc9ab7f.ed5e44","type":"api-call-service","z":"cad8f072.3f332","name":"Reset alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Not set\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":340,"y":820,"wires":[[]]},{"id":"d66196a9.304e58","type":"trigger-state","z":"cad8f072.3f332","name":"Alarm dismissed from snooze","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"input_select.alarm_state","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Not set","propertyValue":"new_state.state"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Snoozed","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":190,"y":640,"wires":[["cc141539.794538"],[]]},{"id":"aef0cd3c.0b78d","type":"trigger-state","z":"cad8f072.3f332","name":"Alarm dismissed from activation","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"input_select.alarm_state","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Not set","propertyValue":"new_state.state"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Activated","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":180,"y":700,"wires":[["cc141539.794538"],[]]},{"id":"1a17b36c.3fb45d","type":"delay","z":"cad8f072.3f332","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":635,"y":560,"wires":[["7ea4f539.e624bc","88bcfa71.18b698"]],"l":false},{"id":"e9a0626b.71ed3","type":"api-current-state","z":"cad8f072.3f332","name":"Snooze time","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_number.snooze_time","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":370,"y":560,"wires":[["b554fdd4.bf56f"]]},{"id":"b554fdd4.bf56f","type":"change","z":"cad8f072.3f332","name":"min to ms","rules":[{"t":"set","p":"delay","pt":"msg","to":"$number(payload)*60000","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":560,"wires":[["1a17b36c.3fb45d"]]},{"id":"cc141539.794538","type":"change","z":"cad8f072.3f332","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":660,"wires":[["1a17b36c.3fb45d","ec60ae7a.5fb4c","33d2b7f3.3b7698"]]},{"id":"cff548aa.a68fb8","type":"change","z":"cad8f072.3f332","name":"Set 0.25 volume","rules":[{"t":"set","p":"alarm_volume","pt":"flow","to":"0.25","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1160,"y":640,"wires":[["cb631689.f161d8"]]},{"id":"33d2b7f3.3b7698","type":"api-current-state","z":"cad8f072.3f332","name":"Play podcast after","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_boolean.switch_alarm_podcast","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":940,"y":660,"wires":[["cff548aa.a68fb8","e5461758.d10938"],["7a08f27d.833efc"]]},{"id":"e4f7d9a0.c6a8d8","type":"api-call-service","z":"cad8f072.3f332","name":"Pause","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"media_pause","entityId":"{{entity_id}}","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1190,"y":680,"wires":[[]]},{"id":"ec60ae7a.5fb4c","type":"change","z":"cad8f072.3f332","name":"stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":620,"wires":[["73b86947.f59d88"]]},{"id":"bd3b178e.7e6208","type":"change","z":"cad8f072.3f332","name":"Set 0.04 volume","rules":[{"t":"set","p":"alarm_volume","pt":"flow","to":"0.04","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":460,"wires":[["cb631689.f161d8"]]},{"id":"7ea4f539.e624bc","type":"api-call-service","z":"cad8f072.3f332","name":"Activate alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\":\"Activated\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":500,"wires":[["73b86947.f59d88"]]},{"id":"604afc44.e34ac4","type":"credentials","z":"e614faca.3700f8","name":"","props":[{"value":"token","type":"msg"}],"x":370,"y":80,"wires":[[]]},{"id":"d5c252cc.1981b","type":"inject","z":"e614faca.3700f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":80,"wires":[["3fc8ccd1.015514"]]},{"id":"3fc8ccd1.015514","type":"debug","z":"e614faca.3700f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"token","targetType":"msg","statusVal":"","statusType":"auto","x":580,"y":80,"wires":[]},{"id":"305ecce4.114bd4","type":"api-current-state","z":"e614faca.3700f8","name":"Podcast select","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.morning_podcast","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":200,"y":340,"wires":[["123f7bda.9c3104"]]},{"id":"123f7bda.9c3104","type":"switch","z":"e614faca.3700f8","name":"podcasts","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"NRC vandaag","vt":"str"},{"t":"eq","v":"NOS met het oog op morgen","vt":"str"},{"t":"eq","v":"VOX today explained","vt":"str"},{"t":"eq","v":"TIMES the daily","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":380,"y":340,"wires":[["db0e869.5384b78"],["68cdcdc5.92c894"],["3a0e8dc8.c566c2"],["1110e0b1.34267f"]]},{"id":"db0e869.5384b78","type":"change","z":"e614faca.3700f8","name":"NRC vandaag","rules":[{"t":"set","p":"payload","pt":"msg","to":"73vZPMVjxTqC02OYZdcCr7","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":280,"wires":[["2ca9503e.dfb61"]]},{"id":"889f7a67.80c368","type":"http request","z":"e614faca.3700f8","name":"Get episode","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.spotify.com/v1/shows/{{payload}}/episodes?market=NL&limit=1&offset=0","tls":"","persist":false,"proxy":"","authType":"","x":390,"y":540,"wires":[["8e47ed5e.b4615","cb4de911.21d608"]]},{"id":"2ca9503e.dfb61","type":"change","z":"e614faca.3700f8","name":"Headers","rules":[{"t":"set","p":"headers","pt":"msg","to":"{\"Accept\":\"application/json\",\"Content-Type\":\"application/json\",\"Authorization\":\"Bearer BQATSHHWgzGkxlRmtivfAEZ-UHp0W7ClLWEs-M7OmIoj-hIzABNtSrw9F_rB8dmvRZ_wcmpkWmprzJsGOdKgJnImwJNFtgEw0_Kq6whUdzZTQRcxpYIGytsSRaV2498gYhTYDPZTvxEio_e8KauCACEvveuiWZzUyT-Mhw4PDRjM1ZzZqXTCl4sJIDtZDLpS3qnrfG7SksHpbl_hinyhGTEKoM1cNECcIKzXt6nig7jECyZaXa3I9xup7j706H08BpN7F8AH5KaiP0Hldw\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":320,"wires":[["889f7a67.80c368"]]},{"id":"99bd88ed.1a2f58","type":"inject","z":"e614faca.3700f8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":200,"wires":[["305ecce4.114bd4"]]},{"id":"8e47ed5e.b4615","type":"function","z":"e614faca.3700f8","name":"","func":"msg.data = {\"uri\": msg.payload.items[0].uri}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":540,"wires":[["85700787.66f4a8"]]},{"id":"85700787.66f4a8","type":"debug","z":"e614faca.3700f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":750,"y":540,"wires":[]},{"id":"68cdcdc5.92c894","type":"change","z":"e614faca.3700f8","name":"NOS het oog","rules":[{"t":"set","p":"payload","pt":"msg","to":"56DJTFqt8Vg1qfLJ1ibH7j","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":320,"wires":[["2ca9503e.dfb61"]]},{"id":"3a0e8dc8.c566c2","type":"change","z":"e614faca.3700f8","name":"VOX today","rules":[{"t":"set","p":"payload","pt":"msg","to":"3pXx5SXzXwJxnf4A5pWN2A","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":360,"wires":[["2ca9503e.dfb61"]]},{"id":"1110e0b1.34267f","type":"change","z":"e614faca.3700f8","name":"TIMES the daily","rules":[{"t":"set","p":"payload","pt":"msg","to":"3IM0lmZxpFAY7CwMuv9H4g","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":400,"wires":[["2ca9503e.dfb61"]]},{"id":"cb4de911.21d608","type":"debug","z":"e614faca.3700f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":550,"y":580,"wires":[]},{"id":"f018816c.f1da9","type":"function","z":"cad8f072.3f332","name":"Increase volume","func":"var alarm_volume = flow.get(\"alarm_volume\");\nalarm_volume = alarm_volume + 0.02;\nflow.set(\"alarm_volume\", alarm_volume);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1160,"y":600,"wires":[["cb631689.f161d8"]]},{"id":"9ebb1fe7.3a2df","type":"api-current-state","z":"cad8f072.3f332","name":"media not paused","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"paused","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"{{entity_id}}","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":850,"y":540,"wires":[["5a5c4cbf.64e5d4"],["2d0a0bbd.7bf334"]]},{"id":"2d0a0bbd.7bf334","type":"api-call-service","z":"cad8f072.3f332","name":"play","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"media_play","entityId":"{{entity_id}}","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1030,"y":540,"wires":[[]]},{"id":"1582bac4.92b5d5","type":"trigger-state","z":"c13ac1ee.fc1dd","name":"sunset","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"sun.sun","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"id":"hkxvoep06yb","targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"above_horizon"},{"id":"xssebl3jxjo","targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"below_horizon"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":130,"y":120,"wires":[["4602515d.86f95"],[]]},{"id":"4602515d.86f95","type":"api-current-state","z":"c13ac1ee.fc1dd","name":"lights on","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"light.bedroom_lights","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":280,"y":120,"wires":[["e4031da7.b1114"],[]]},{"id":"e4031da7.b1114","type":"function","z":"c13ac1ee.fc1dd","name":"","func":"msg.payload = {\n    \"data\": {\n        \"message\": \"The sun has set, would you like evening lights?\",\n        \"data\": {\n            \"actions\": [\n                {\n                    \"action\": \"evening_light\",\n                    \"title\": \"Yes\"\n                },\n                {\n                    \"action\": \"night_light\",\n                    \"title\": \"Night\"\n                },\n            ]\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":430,"y":120,"wires":[["a73a2af2.b9b328"]]},{"id":"a7c0d280.c7463","type":"server-events","z":"c13ac1ee.fc1dd","name":"","server":"cd10b942.aa6d58","event_type":"mobile_app_notification_action","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":230,"y":800,"wires":[["6bf57816.5c84f8"]]},{"id":"6bf57816.5c84f8","type":"switch","z":"c13ac1ee.fc1dd","name":"","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"evening_light","vt":"str"},{"t":"eq","v":"night_light","vt":"str"},{"t":"eq","v":"yellow_light","vt":"str"},{"t":"eq","v":"dismiss_alarm","vt":"str"},{"t":"eq","v":"snooze_alarm","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":490,"y":800,"wires":[["ed823843.826768"],["96755820.6e4188"],["48b961bf.8493"],["55e163a4.2eddcc"],["f90bc488.54dd38"]]},{"id":"ed823843.826768","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"evening light","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.evening_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":700,"wires":[[]]},{"id":"25e8ed6c.3c7f32","type":"server-events","z":"c13ac1ee.fc1dd","name":"","server":"cd10b942.aa6d58","event_type":"tag_scanned","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":180,"y":600,"wires":[["24c17488.96a99c"]]},{"id":"24c17488.96a99c","type":"change","z":"c13ac1ee.fc1dd","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.event.tag_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":600,"wires":[["1a2faa36.f236d6"]]},{"id":"1a2faa36.f236d6","type":"switch","z":"c13ac1ee.fc1dd","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"3d92c0bd-6342-420a-8641-461e2d4fbff0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":570,"y":600,"wires":[["12cd4259.3439ee"]]},{"id":"12cd4259.3439ee","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"Toggle NFC","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"toggle","entityId":"input_boolean.automation_nfc_state","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":720,"y":600,"wires":[[]]},{"id":"3eff726c.fc3d6e","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"Lights off","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"light","service":"turn_off","entityId":"light.bedroom_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":280,"wires":[["c3ec1b27.dac3e8"]]},{"id":"2597455b.4b45aa","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"Transfer spotify","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"spotcast","service":"start","entityId":"","data":"{\"device_name\":\"{{device_name}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":670,"y":360,"wires":[[]]},{"id":"38368d58.ab0312","type":"function","z":"c13ac1ee.fc1dd","name":"","func":"var state = msg.payload;\nif (state == \"on\"){\n    msg.device_name = \"OnePlus 6\"\n}\nelse {\n    msg.device_name = \"HomeAssistant\"\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":330,"y":280,"wires":[["c8c5eed7.93004","2d293c1.afc01c4"]]},{"id":"c8c5eed7.93004","type":"switch","z":"c13ac1ee.fc1dd","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":260,"wires":[["3ef63604.20f90a"],["3eff726c.fc3d6e","db144397.5a801"]]},{"id":"6f1b1679.90e598","type":"server-state-changed","z":"c13ac1ee.fc1dd","name":"","server":"cd10b942.aa6d58","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"person.mark","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"x":200,"y":440,"wires":[["95fb3c64.b5333"]]},{"id":"95fb3c64.b5333","type":"switch","z":"c13ac1ee.fc1dd","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Home","vt":"str"},{"t":"eq","v":"Away","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":440,"wires":[["96404453.966498"],["74cbef91.d834f"]]},{"id":"2a2d75a2.70185a","type":"server-state-changed","z":"c13ac1ee.fc1dd","name":"NFC home state","server":"cd10b942.aa6d58","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.automation_nfc_state","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":170,"y":280,"wires":[["38368d58.ab0312"]]},{"id":"96404453.966498","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_on","entityId":"input_boolean.automation_nfc_state","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":600,"y":420,"wires":[[]]},{"id":"74cbef91.d834f","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_boolean","service":"turn_off","entityId":"input_boolean.automation_nfc_state","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":600,"y":460,"wires":[[]]},{"id":"2d293c1.afc01c4","type":"api-current-state","z":"c13ac1ee.fc1dd","name":"Spotify","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"media_player.spotify_mark_shui_hu","state_type":"str","state_location":"spotify_playing","override_payload":"msg","entity_location":"","override_data":"none","blockInputOverrides":false,"x":510,"y":360,"wires":[["2597455b.4b45aa"],[]]},{"id":"3ef63604.20f90a","type":"api-current-state","z":"c13ac1ee.fc1dd","name":"sun","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"above_horizon","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sun.sun","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":670,"y":220,"wires":[["d3e18c4.29ee77"],["caa19024.fb933"]]},{"id":"d3e18c4.29ee77","type":"function","z":"c13ac1ee.fc1dd","name":"","func":"msg.payload = {\n    \"data\": {\n        \"message\": \"Welcome home! Yellow lights?\",\n        \"data\": {\n            \"actions\": [\n                {\n                    \"action\": \"yellow_light\",\n                    \"title\": \"Yes\"\n                },\n                {\n                    \"action\": \"evening_light\",\n                    \"title\": \"Evening\"\n                },\n                {\n                    \"action\": \"night_light\",\n                    \"title\": \"Night\"\n                },\n            ]\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":220,"wires":[["802c17cc.61f928"]]},{"id":"c3ec1b27.dac3e8","type":"function","z":"c13ac1ee.fc1dd","name":"","func":"msg.payload = {\n    \"data\": {\n        \"message\": \"Good bye!\"\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":830,"y":300,"wires":[["802c17cc.61f928"]]},{"id":"caa19024.fb933","type":"function","z":"c13ac1ee.fc1dd","name":"","func":"msg.payload = {\n    \"data\": {\n        \"message\": \"Welcome home! Evening lights?\",\n        \"data\": {\n            \"actions\": [\n                {\n                    \"action\": \"evening_light\",\n                    \"title\": \"Yes\"\n                },\n                {\n                    \"action\": \"yellow_light\",\n                    \"title\": \"Yellow\"\n                },\n                {\n                    \"action\": \"night_light\",\n                    \"title\": \"Night\"\n                },\n            ]\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":830,"y":260,"wires":[["802c17cc.61f928"]]},{"id":"96755820.6e4188","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"night light","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.night_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":740,"wires":[[]]},{"id":"48b961bf.8493","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"yellow light","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.yellow_light","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":760,"y":780,"wires":[[]]},{"id":"dbd6005.57068","type":"comment","z":"c13ac1ee.fc1dd","name":"Evening light at sunset","info":"Ask for evening light at sun set.","x":170,"y":80,"wires":[]},{"id":"9b8fe5d0.392d88","type":"comment","z":"c13ac1ee.fc1dd","name":"Presence auto","info":"","x":150,"y":240,"wires":[]},{"id":"ed7932da.1a93e","type":"comment","z":"c13ac1ee.fc1dd","name":"NFC events","info":"","x":160,"y":560,"wires":[]},{"id":"ee12a25e.5999f","type":"comment","z":"c13ac1ee.fc1dd","name":"App action events","info":"","x":180,"y":760,"wires":[]},{"id":"4d67a780.d29d68","type":"server-events","z":"9148f6af.55f788","name":"","server":"cd10b942.aa6d58","event_type":"zha_event","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"x":140,"y":80,"wires":[["ca10e11b.56c35"]]},{"id":"6ee481cb.44d77","type":"switch","z":"9148f6af.55f788","name":"Devices","property":"payload.device_ieee","propertyType":"msg","rules":[{"t":"eq","v":"68:0a:e2:ff:fe:a4:07:f0","vt":"str"},{"t":"eq","v":"00:15:8d:00:04:61:88:4a","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":150,"y":540,"wires":[["1017f3b5.15604c"],["fa7cffd.efa5e"]]},{"id":"ca10e11b.56c35","type":"change","z":"9148f6af.55f788","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.event","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":360,"y":80,"wires":[["6ee481cb.44d77"]]},{"id":"c91d349c.7c2bd8","type":"switch","z":"9148f6af.55f788","name":"Tradfri commands","property":"payload.command","propertyType":"msg","rules":[{"t":"eq","v":"hold","vt":"str"},{"t":"eq","v":"release","vt":"str"},{"t":"eq","v":"step_with_on_off","vt":"str"},{"t":"eq","v":"step","vt":"str"},{"t":"eq","v":"move_with_on_off","vt":"str"},{"t":"eq","v":"move","vt":"str"},{"t":"eq","v":"stop","vt":"str"},{"t":"eq","v":"press","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":9,"x":780,"y":600,"wires":[["e0003bd.83f3ec8"],[],["26de3e10.39d3d2","5edbf3e6.383e7c"],["26de3e10.39d3d2","a5dda533.6ea7a8"],["26de3e10.39d3d2","906cbc1e.4993b"],["26de3e10.39d3d2","62df0755.589df8"],["48af22fd.054fec"],["67f77875.979088"],["7d207740.8f3a28"]]},{"id":"fa7cffd.efa5e","type":"switch","z":"9148f6af.55f788","name":"Xiaomi commands","property":"payload.args.value","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"},{"t":"eq","v":"128","vt":"num"}],"checkall":"true","repair":false,"outputs":6,"x":780,"y":780,"wires":[["7d207740.8f3a28"],[],["8bdaeb4c.fc9038"],["31d9ffbc.ceced"],["f3cf70b5.31081"],["66e21f88.bbef5"]]},{"id":"67f77875.979088","type":"switch","z":"9148f6af.55f788","name":"Left/Right press","property":"payload.args[0]","propertyType":"msg","rules":[{"t":"eq","v":"256","vt":"num"},{"t":"eq","v":"257","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1010,"y":660,"wires":[["8bdaeb4c.fc9038"],["31d9ffbc.ceced"]]},{"id":"7d207740.8f3a28","type":"api-call-service","z":"9148f6af.55f788","name":"toggle lights","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"light","service":"toggle","entityId":"light.bedroom_lights","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1020,"y":700,"wires":[[]]},{"id":"8bdaeb4c.fc9038","type":"api-call-service","z":"9148f6af.55f788","name":"next scene","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_next","entityId":"input_select.light_scene","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1260,"y":700,"wires":[[]]},{"id":"31d9ffbc.ceced","type":"api-call-service","z":"9148f6af.55f788","name":"prev scene","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_previous","entityId":"input_select.light_scene","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1260,"y":740,"wires":[[]]},{"id":"ef093d1c.cdfbc","type":"api-call-service","z":"9148f6af.55f788","name":"Dismiss","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Not set\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1250,"y":860,"wires":[[]]},{"id":"66e21f88.bbef5","type":"api-current-state","z":"9148f6af.55f788","name":"Alarm activated or snoozed","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"Activated,Snoozed","halt_if_type":"str","halt_if_compare":"includes","override_topic":false,"entity_id":"input_select.alarm_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1040,"y":860,"wires":[["ef093d1c.cdfbc"],[]]},{"id":"f3cf70b5.31081","type":"api-current-state","z":"9148f6af.55f788","name":"No alarm","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"Activated","halt_if_type":"str","halt_if_compare":"is_not","override_topic":false,"entity_id":"input_select.alarm_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":1000,"y":820,"wires":[[],["efa33f0e.31a0d"]]},{"id":"efa33f0e.31a0d","type":"api-call-service","z":"9148f6af.55f788","name":"Snoozed","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Snoozed\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1250,"y":820,"wires":[[]]},{"id":"fb7273c9.02f07","type":"ha-get-entities","z":"9148f6af.55f788","server":"cd10b942.aa6d58","name":"","rules":[{"property":"entity_id","logic":"includes","value":"light.door,light.desk,light.bed,light.couch,light.cabinet,light.strip","valueType":"str"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1260,"y":440,"wires":[["da1c044c.363738"]]},{"id":"da1c044c.363738","type":"function","z":"9148f6af.55f788","name":"","func":"var i;\nvar entities = [];\nfor (i = 0; i < msg.payload.length; i++) {\n  entities.push(msg.payload[i].entity_id);\n}\nflow.set(\"light_entities\", entities);","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1420,"y":440,"wires":[[]]},{"id":"26de3e10.39d3d2","type":"delay","z":"9148f6af.55f788","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1090,"y":440,"wires":[["fb7273c9.02f07"]]},{"id":"906cbc1e.4993b","type":"looptimer","z":"9148f6af.55f788","duration":"1","units":"Second","maxloops":"10","maxtimeout":"10","maxtimeoutunits":"Second","name":"","x":1115,"y":525,"wires":[["5edbf3e6.383e7c"],[]],"l":false},{"id":"a6e57a02.8cb338","type":"api-call-service","z":"9148f6af.55f788","name":"","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1740,"y":540,"wires":[[]]},{"id":"48af22fd.054fec","type":"change","z":"9148f6af.55f788","name":"stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":620,"wires":[["906cbc1e.4993b","62df0755.589df8"]]},{"id":"e4bf0a16.058ca8","type":"split","z":"9148f6af.55f788","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1361,"y":500,"wires":[["2d0dc72f.a5ba28"]]},{"id":"5edbf3e6.383e7c","type":"change","z":"9148f6af.55f788","name":"Get lights","rules":[{"t":"set","p":"payload","pt":"msg","to":"light_entities","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":1221,"y":500,"wires":[["e4bf0a16.058ca8"]]},{"id":"2d0dc72f.a5ba28","type":"change","z":"9148f6af.55f788","name":"+10","rules":[{"t":"set","p":"entity","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"{\"data\": {}}","tot":"json"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity","tot":"msg"},{"t":"set","p":"payload.data.brightness_step_pct","pt":"msg","to":"10","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1481,"y":500,"wires":[["a6e57a02.8cb338"]]},{"id":"62df0755.589df8","type":"looptimer","z":"9148f6af.55f788","duration":"1","units":"Second","maxloops":"10","maxtimeout":"10","maxtimeoutunits":"Second","name":"","x":1115,"y":580,"wires":[["a5dda533.6ea7a8"],[]],"l":false},{"id":"f50af4bd.1c4b58","type":"split","z":"9148f6af.55f788","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1360,"y":560,"wires":[["bd7997db.a06288"]]},{"id":"a5dda533.6ea7a8","type":"change","z":"9148f6af.55f788","name":"Get lights","rules":[{"t":"set","p":"payload","pt":"msg","to":"light_entities","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":1220,"y":560,"wires":[["f50af4bd.1c4b58"]]},{"id":"bd7997db.a06288","type":"change","z":"9148f6af.55f788","name":"-10","rules":[{"t":"set","p":"entity","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"{\"data\": {}}","tot":"json"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity","tot":"msg"},{"t":"set","p":"payload.data.brightness_step_pct","pt":"msg","to":"-10","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1480,"y":560,"wires":[["a6e57a02.8cb338"]]},{"id":"e0003bd.83f3ec8","type":"switch","z":"9148f6af.55f788","name":"Left/Right hold","property":"payload.args[0]","propertyType":"msg","rules":[{"t":"eq","v":"3328","vt":"num"},{"t":"eq","v":"3329","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1030,"y":360,"wires":[["a75fdc4a.f86c7"],["50bfc2b4.ffb0cc"]]},{"id":"a75fdc4a.f86c7","type":"api-call-service","z":"9148f6af.55f788","name":"light mode","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.button_mode","data":"{\"option\": \"light\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1200,"y":340,"wires":[[]]},{"id":"50bfc2b4.ffb0cc","type":"api-call-service","z":"9148f6af.55f788","name":"media mode","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.button_mode","data":"{\"option\": \"media\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1210,"y":380,"wires":[[]]},{"id":"1017f3b5.15604c","type":"api-current-state","z":"9148f6af.55f788","name":"Button mode","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.button_mode","state_type":"str","state_location":"mode","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":370,"y":400,"wires":[["ea398a16.141458"]]},{"id":"ea398a16.141458","type":"switch","z":"9148f6af.55f788","name":"","property":"mode","propertyType":"msg","rules":[{"t":"eq","v":"media","vt":"str"},{"t":"eq","v":"light","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":530,"y":400,"wires":[["aa2de39.0603b2"],["c91d349c.7c2bd8"]]},{"id":"aa2de39.0603b2","type":"switch","z":"9148f6af.55f788","name":"Tradfri commands","property":"payload.command","propertyType":"msg","rules":[{"t":"eq","v":"hold","vt":"str"},{"t":"eq","v":"release","vt":"str"},{"t":"eq","v":"step_with_on_off","vt":"str"},{"t":"eq","v":"step","vt":"str"},{"t":"eq","v":"move_with_on_off","vt":"str"},{"t":"eq","v":"move","vt":"str"},{"t":"eq","v":"stop","vt":"str"},{"t":"eq","v":"press","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":9,"x":780,"y":160,"wires":[["e0003bd.83f3ec8"],[],["5da3fce.958b104"],["2fcf2d3b.e08e62"],["64c777d1.ae2e08"],["d0674a32.fb19e8"],["5c290113.cc13"],["49f3bdd0.def464"],["423a958e.6a9bdc"]]},{"id":"423a958e.6a9bdc","type":"api-call-service","z":"9148f6af.55f788","name":"playpause","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"media_play_pause","entityId":"media_player.spotify_mark_shui_hu","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1020,"y":280,"wires":[[]]},{"id":"49f3bdd0.def464","type":"switch","z":"9148f6af.55f788","name":"Left/Right press","property":"payload.args[0]","propertyType":"msg","rules":[{"t":"eq","v":"256","vt":"num"},{"t":"eq","v":"257","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1030,"y":240,"wires":[["bd249d1b.5ee5a"],["a134a6ca.f19418"]]},{"id":"bd249d1b.5ee5a","type":"api-call-service","z":"9148f6af.55f788","name":"next track","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"media_next_track","entityId":"media_player.spotify_mark_shui_hu","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1240,"y":240,"wires":[[]]},{"id":"a134a6ca.f19418","type":"api-call-service","z":"9148f6af.55f788","name":"previous track","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"media_previous_track","entityId":"media_player.spotify_mark_shui_hu","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1250,"y":280,"wires":[[]]},{"id":"2fcf2d3b.e08e62","type":"looptimer","z":"9148f6af.55f788","duration":"1","units":"Second","maxloops":"10","maxtimeout":"10","maxtimeoutunits":"Second","name":"","x":1155,"y":80,"wires":[["5da3fce.958b104"],[]],"l":false},{"id":"5da3fce.958b104","type":"api-call-service","z":"9148f6af.55f788","name":"volume up","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"volume_up","entityId":"media_player.spotify_mark_shui_hu","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1260,"y":60,"wires":[[]]},{"id":"d0674a32.fb19e8","type":"looptimer","z":"9148f6af.55f788","duration":"1","units":"Second","maxloops":"10","maxtimeout":"10","maxtimeoutunits":"Second","name":"","x":1155,"y":160,"wires":[["64c777d1.ae2e08"],[]],"l":false},{"id":"5c290113.cc13","type":"change","z":"9148f6af.55f788","name":"stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1030,"y":200,"wires":[["d0674a32.fb19e8","2fcf2d3b.e08e62"]]},{"id":"64c777d1.ae2e08","type":"api-call-service","z":"9148f6af.55f788","name":"volume down","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"volume_down","entityId":"media_player.spotify_mark_shui_hu","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1270,"y":120,"wires":[[]]},{"id":"db144397.5a801","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"switches off","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_off","entityId":"switch.desk_top_mirror","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":680,"y":320,"wires":[[]]},{"id":"bc06bcd2.36e02","type":"server-state-changed","z":"cad8f072.3f332","name":"","server":"cd10b942.aa6d58","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_datetime.alarm_time","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":200,"y":80,"wires":[["921218fe.7fe898","d6f082d8.7f2c4"]]},{"id":"7c90179b.d55618","type":"change","z":"cad8f072.3f332","name":"","rules":[{"t":"set","p":"alarm_time","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":60,"wires":[[]]},{"id":"921218fe.7fe898","type":"api-render-template","z":"cad8f072.3f332","name":"Get light time","server":"cd10b942.aa6d58","template":"{{ ((state_attr(\"input_datetime.alarm_time\", \"timestamp\") - 300) | timestamp_custom(\"%H:%M\", False)) }}","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":450,"y":100,"wires":[["53550085.ca198"]]},{"id":"53550085.ca198","type":"change","z":"cad8f072.3f332","name":"","rules":[{"t":"set","p":"alarm_light_time","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":100,"wires":[[]]},{"id":"d6f082d8.7f2c4","type":"api-render-template","z":"cad8f072.3f332","name":"Get alarm time","server":"cd10b942.aa6d58","template":"{{ (state_attr(\"input_datetime.alarm_time\", \"timestamp\") | timestamp_custom(\"%H:%M\", False)) }}","resultsLocation":"payload","resultsLocationType":"msg","templateLocation":"template","templateLocationType":"msg","x":450,"y":60,"wires":[["7c90179b.d55618"]]},{"id":"5d092b91.6f7e24","type":"api-call-service","z":"cad8f072.3f332","name":"Wakeup lights on","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.wakeup_lights","data":"{\"brightness\":1,\"color_temp\":588}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":840,"y":260,"wires":[["32b9f33a.e7caac"]]},{"id":"32b9f33a.e7caac","type":"api-call-service","z":"cad8f072.3f332","name":"Brightness transition","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.wakeup_lights","data":"{\"brightness\":200,\"transition\":300}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1050,"y":260,"wires":[["6578ff12.bd719"]]},{"id":"ded00f62.e2f02","type":"api-call-service","z":"cad8f072.3f332","name":"Brightness transition","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"light","service":"turn_on","entityId":"light.wakeup_lights","data":"{\"color_temp\":333,\"transition\":300}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1430,"y":260,"wires":[[]]},{"id":"6578ff12.bd719","type":"delay","z":"cad8f072.3f332","name":"","pauseType":"delay","timeout":"300","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1240,"y":260,"wires":[["ded00f62.e2f02"]]},{"id":"1422d08d.13746f","type":"api-call-service","z":"cad8f072.3f332","name":"Lost in Japan ","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"script","service":"turn_on","entityId":"script.play_lost_in_japan","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1310,"y":360,"wires":[[]]},{"id":"c7110781.9950f8","type":"function","z":"cad8f072.3f332","name":"","func":"msg.payload = {\n    \"data\": {\n        \"message\": \"Alarm activated!\",\n        \"data\": {\n            \"actions\": [\n                {\n                    \"action\": \"snooze_alarm\",\n                    \"title\": \"Snooze\"\n                },\n                {\n                    \"action\": \"dismiss_alarm\",\n                    \"title\": \"Dismiss\"\n                },\n            ]\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":360,"wires":[["ea041a67.574f38"]]},{"id":"f90bc488.54dd38","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"snooze alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Snoozed\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":860,"wires":[[]]},{"id":"55e163a4.2eddcc","type":"api-call-service","z":"c13ac1ee.fc1dd","name":"dismiss alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Not set\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":820,"wires":[[]]},{"id":"8b50dc20.c69e7","type":"trigger-state","z":"c13ac1ee.fc1dd","name":"Mark home","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"person.mark","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"home","propertyValue":"new_state.state"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"away","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":500,"y":220,"wires":[["3ef63604.20f90a"],[]]},{"id":"c611e2ca.ed1f5","type":"trigger-state","z":"c13ac1ee.fc1dd","name":"Mark away","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"person.mark","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"away","propertyValue":"new_state.state"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"home","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":500,"y":300,"wires":[["3eff726c.fc3d6e","db144397.5a801"],[]]},{"id":"a4eba80b.78fd98","type":"trigger-state","z":"cad8f072.3f332","name":"prev unavailable","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"sensor.oneplus_6_next_alarm","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"unavailable","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":140,"y":1040,"wires":[["bbcc7baf.fed3d8"],["4b70f3cc.f985dc"]]},{"id":"4b70f3cc.f985dc","type":"api-current-state","z":"cad8f072.3f332","name":"now unavailable","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"unavailable","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.oneplus_6_next_alarm","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":240,"y":1100,"wires":[["158aa1a5.6611ee"],["bbcc7baf.fed3d8"]]},{"id":"38e77baf.bfc7e4","type":"api-current-state","z":"cad8f072.3f332","name":"Mark Home","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"person.mark","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":760,"y":1040,"wires":[["30448785.b03688","25e9a50a.11a60a"],[]]},{"id":"1d1b34a3.cfae5b","type":"comment","z":"cad8f072.3f332","name":"Alarm set from phone","info":"","x":150,"y":1000,"wires":[]},{"id":"86a70f1c.e6959","type":"api-current-state","z":"cad8f072.3f332","name":"Alarm time","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_datetime.alarm_time","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":830,"y":1100,"wires":[["49f8b898.3e4b28"]]},{"id":"27d53d79.aac132","type":"switch","z":"cad8f072.3f332","name":"New alarm","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"alarm_time","vt":"flow"}],"checkall":"true","repair":false,"outputs":1,"x":600,"y":1040,"wires":[["38e77baf.bfc7e4"]]},{"id":"25e9a50a.11a60a","type":"function","z":"cad8f072.3f332","name":"","func":"var message = \"Your alarm is set at \" + flow.get(\"alarm_short\");\nmsg.payload = {\n    \"data\": {\n        \"title\": \"Alarm set\",\n        \"message\": message\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1140,"y":1180,"wires":[["3bfb1328.c17e7c"]]},{"id":"49f8b898.3e4b28","type":"function","z":"cad8f072.3f332","name":"","func":"var message = \"Your alarm at \" + msg.payload.substr(0,5) + \" is cancelled!\"\nmsg.payload = {\n    \"data\": {\n        \"title\": \"Alarm cancelled\",\n        \"message\": message\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1140,"y":1140,"wires":[["3bfb1328.c17e7c"]]},{"id":"bbcc7baf.fed3d8","type":"function","z":"cad8f072.3f332","name":"","func":"\nmsg.phone_alarm = new Date(msg.payload);\nvar now = (new Date()).getTime(); \nif (msg.phone_alarm.getTime() - now < 24*60*60*1000) {\n    flow.set(\"alarm_time\", msg.phone_alarm.toTimeString().split(\" \")[0]);\n    var time_short = [msg.phone_alarm.getHours(), msg.phone_alarm.getMinutes()].map(digit => {\n        return digit.toLocaleString('en-US', {\n            minimumIntegerDigits: 2, \n            useGrouping: false\n        });\n    });\n    flow.set(\"alarm_short\", time_short.join(\":\"));\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":1040,"wires":[["27d53d79.aac132"]]},{"id":"30448785.b03688","type":"api-call-service","z":"cad8f072.3f332","name":"alarm set from phone","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Set from phone\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1010,"y":1000,"wires":[["7710e10a.7ba52"]]},{"id":"581abfb3.1def3","type":"api-call-service","z":"cad8f072.3f332","name":"stop alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Not set\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":660,"y":1100,"wires":[["86a70f1c.e6959"]]},{"id":"158aa1a5.6611ee","type":"api-current-state","z":"cad8f072.3f332","name":"alarm set from phone","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"Set from phone","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.alarm_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":470,"y":1100,"wires":[["581abfb3.1def3"],[]]},{"id":"aeca9612.40ea28","type":"trigger-state","z":"cad8f072.3f332","name":"prev unavailable","server":"cd10b942.aa6d58","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"sensor.bedroom_speaker_alarms","entityidfiltertype":"exact","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"unavailable","propertyValue":"old_state.state"}],"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","x":140,"y":1260,"wires":[["c7c3e988.fa8978","c1df59e0.eaf398"],["b7549f52.3dce7"]]},{"id":"b7549f52.3dce7","type":"api-current-state","z":"cad8f072.3f332","name":"now unavailable","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"unavailable","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.oneplus_6_next_alarm","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":240,"y":1320,"wires":[["9b5a9d71.01851"],["c7c3e988.fa8978"]]},{"id":"169ff1bf.35a13e","type":"comment","z":"cad8f072.3f332","name":"Alarm set from speaker","info":"","x":150,"y":1220,"wires":[]},{"id":"8149399f.869638","type":"api-current-state","z":"cad8f072.3f332","name":"Alarm time","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_datetime.alarm_time","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":930,"y":1320,"wires":[["49f8b898.3e4b28"]]},{"id":"c7c3e988.fa8978","type":"function","z":"cad8f072.3f332","name":"","func":"\nmsg.phone_alarm = new Date(msg.payload);\nvar now = (new Date()).getTime(); \nif (msg.phone_alarm.getTime() - now < 24*60*60*1000) {\n    flow.set(\"alarm_time\", msg.phone_alarm.toTimeString().split(\" \")[0]);\n    var time_short = [msg.phone_alarm.getHours(), msg.phone_alarm.getMinutes()].map(digit => {\n        return digit.toLocaleString('en-US', {\n            minimumIntegerDigits: 2, \n            useGrouping: false\n        });\n    });\n    flow.set(\"alarm_short\", time_short.join(\":\"));\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":1260,"wires":[["3282656.ce02a9a"]]},{"id":"b0ba913d.9301","type":"api-call-service","z":"cad8f072.3f332","name":"alarm set from speaker","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Set from speaker\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":880,"y":1260,"wires":[["69fd5d37.8d2ae4"]]},{"id":"eb24e338.d01b5","type":"api-call-service","z":"cad8f072.3f332","name":"stop alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_select","service":"select_option","entityId":"input_select.alarm_state","data":"{\"option\": \"Not set\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":770,"y":1320,"wires":[["8149399f.869638"]]},{"id":"78a9c246.f6919c","type":"api-current-state","z":"cad8f072.3f332","name":"alarm set from speaker","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"Set from speaker","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.alarm_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":580,"y":1320,"wires":[["eb24e338.d01b5"],[]]},{"id":"7710e10a.7ba52","type":"api-call-service","z":"cad8f072.3f332","name":"Set alarm time","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_datetime","service":"set_datetime","entityId":"input_datetime.alarm_time","data":"{\"time\":\"{{flow.alarm_time}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1210,"y":1000,"wires":[[]]},{"id":"69fd5d37.8d2ae4","type":"api-call-service","z":"cad8f072.3f332","name":"Set alarm time","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"input_datetime","service":"set_datetime","entityId":"input_datetime.alarm_time","data":"{\"time\":\"{{flow.alarm_time}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1090,"y":1260,"wires":[["1423c61.b21293a"]]},{"id":"323b29d7.95dde6","type":"server-state-changed","z":"cad8f072.3f332","name":"Alarm light trigger","server":"cd10b942.aa6d58","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.time","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"alarm_light_time","halt_if_type":"global","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":140,"y":280,"wires":[["bb952d5a.7f90b"],[]]},{"id":"4bda0ec4.46823","type":"switch","z":"cad8f072.3f332","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Set from phone","vt":"str"},{"t":"eq","v":"Set","vt":"str"},{"t":"eq","v":"Set from speaker","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":435,"y":280,"wires":[["915632e5.b06e3"],["5d092b91.6f7e24"],["dd90b2a1.7d479"]],"l":false},{"id":"1423c61.b21293a","type":"api-current-state","z":"cad8f072.3f332","name":"Save alarm state","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"sensor.bedroom_speaker_alarms","state_type":"str","state_location":"","override_payload":"none","entity_location":"bedroom_speaker_alarm","override_data":"global","blockInputOverrides":false,"x":1280,"y":1260,"wires":[[]]},{"id":"bb952d5a.7f90b","type":"api-current-state","z":"cad8f072.3f332","name":"alarm state","server":"cd10b942.aa6d58","version":1,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"input_select.alarm_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":320,"y":280,"wires":[["4bda0ec4.46823"]]},{"id":"915632e5.b06e3","type":"api-current-state","z":"cad8f072.3f332","name":"Mark home?","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","override_topic":false,"entity_id":"person.mark","state_type":"str","state_location":"","override_payload":"none","entity_location":"","override_data":"none","blockInputOverrides":false,"x":590,"y":240,"wires":[["5d092b91.6f7e24"],[]]},{"id":"dd90b2a1.7d479","type":"api-call-service","z":"cad8f072.3f332","name":"delete speaker alarm","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"google_home","service":"delete_alarm","entityId":"sensor.bedroom_speaker_alarms","data":"{\"timer_id\":\"{{flow.alarm_id.attributes.alarms[0].alarm_id}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":590,"y":300,"wires":[["5d092b91.6f7e24"]]},{"id":"ea041a67.574f38","type":"subflow:d79169ed.74c6f8","z":"cad8f072.3f332","name":"","env":[],"x":940,"y":360,"wires":[]},{"id":"bb0e717.87eeb9","type":"api-call-service","z":"d79169ed.74c6f8","name":"Notify Oneplus","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"notify","service":"mobile_app_oneplus_a6003","entityId":"","data":"","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":330,"y":160,"wires":[[]]},{"id":"3bfb1328.c17e7c","type":"subflow:d79169ed.74c6f8","z":"cad8f072.3f332","name":"","env":[],"x":1290,"y":1160,"wires":[]},{"id":"802c17cc.61f928","type":"subflow:d79169ed.74c6f8","z":"c13ac1ee.fc1dd","name":"","env":[],"x":980,"y":260,"wires":[]},{"id":"a73a2af2.b9b328","type":"subflow:d79169ed.74c6f8","z":"c13ac1ee.fc1dd","name":"","env":[],"x":580,"y":120,"wires":[]},{"id":"64952550.9bfb1c","type":"server-state-changed","z":"cad8f072.3f332","name":"Alarm trigger","server":"cd10b942.aa6d58","version":1,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.time","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"alarm_time","halt_if_type":"global","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"x":120,"y":420,"wires":[["abedcf50.a501d"],[]]},{"id":"abedcf50.a501d","type":"api-current-state","z":"cad8f072.3f332","name":"Alarm set in frontend or speaker","server":"cd10b942.aa6d58","version":1,"outputs":2,"halt_if":"Set, Set from speaker","halt_if_type":"str","halt_if_compare":"includes","override_topic":false,"entity_id":"input_select.alarm_state","state_type":"str","state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","blockInputOverrides":false,"x":370,"y":420,"wires":[["c7110781.9950f8","5a5c4cbf.64e5d4","7ea4f539.e624bc","bd3b178e.7e6208"],[]]},{"id":"3282656.ce02a9a","type":"switch","z":"cad8f072.3f332","name":"New alarm","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"alarm_time","vt":"flow"}],"checkall":"true","repair":false,"outputs":1,"x":610,"y":1260,"wires":[["b0ba913d.9301","25e9a50a.11a60a"]]},{"id":"c2af155d.26a098","type":"change","z":"168dec6b.d1ade4","name":"","rules":[{"t":"set","p":"entity_id","pt":"msg","to":"media_player.google_home","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":180,"wires":[[]]},{"id":"5c590e95.ef56a","type":"api-call-service","z":"cad8f072.3f332","name":"Set volume","server":"cd10b942.aa6d58","version":1,"debugenabled":false,"service_domain":"media_player","service":"volume_set","entityId":"{{entity_id}}","data":"{\"volume_level\":\"{{flow.alarm_volume}}\"}","dataType":"json","mergecontext":"","output_location":"","output_location_type":"none","mustacheAltTags":false,"x":1440,"y":540,"wires":[[]]},{"id":"88bcfa71.18b698","type":"subflow:168dec6b.d1ade4","z":"cad8f072.3f332","name":"","env":[],"x":715,"y":560,"wires":[["9ebb1fe7.3a2df"]],"l":false},{"id":"7a08f27d.833efc","type":"subflow:168dec6b.d1ade4","z":"cad8f072.3f332","name":"","env":[],"x":1095,"y":680,"wires":[["e4f7d9a0.c6a8d8"]],"l":false},{"id":"9b5a9d71.01851","type":"delay","z":"cad8f072.3f332","name":"","pauseType":"delay","timeout":"60","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":435,"y":1320,"wires":[["78a9c246.f6919c"]],"l":false},{"id":"c1df59e0.eaf398","type":"change","z":"cad8f072.3f332","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":315,"y":1280,"wires":[["9b5a9d71.01851"]],"l":false},{"id":"aa52e81.742a118","type":"inject","z":"cad8f072.3f332","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":380,"wires":[["abedcf50.a501d"]]},{"id":"cb631689.f161d8","type":"subflow:168dec6b.d1ade4","z":"cad8f072.3f332","name":"","env":[],"x":1335,"y":540,"wires":[["5c590e95.ef56a"]],"l":false}]